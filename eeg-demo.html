<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Live EEG Processing Demo - PSYCH 403A1</title>
    <style>
        :root {
            --bg: #1a1a1a;
            --text: #ffffff;
            --accent: #00ff88;
            --accent-2: #ff6b9d;
            --border: #333;
        }

        body {
            margin: 0;
            padding: 20px;
            background: var(--bg);
            color: var(--text);
            font-family: 'Monaco', 'Menlo', monospace;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid var(--accent);
            border-radius: 10px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 10px 20px;
            background: var(--accent);
            color: var(--bg);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
        }

        button:hover {
            background: var(--accent-2);
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: #2a2a2a;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
        }

        .panel h3 {
            margin: 0 0 15px 0;
            color: var(--accent);
        }

        #eegCanvas, #spectrumCanvas {
            width: 100%;
            height: 200px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: #000;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .metric {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .metric-label {
            font-size: 12px;
            color: #aaa;
        }

        .metric-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--accent);
        }

        .log {
            background: #111;
            border: 1px solid var(--border);
            border-radius: 5px;
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            font-size: 12px;
            font-family: monospace;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
        }

        .status-indicator.connected {
            background: var(--accent);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .code-section {
            background: #1e1e1e;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .code-section h4 {
            color: var(--accent-2);
            margin: 0 0 15px 0;
        }

        pre {
            background: #0d1117;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 3px solid var(--accent);
        }

        code {
            color: #f8f8f2;
        }

        .highlight { color: var(--accent); }
        .comment { color: #6a737d; }
        .string { color: #9ecbff; }
        .number { color: #79c0ff; }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ§  Live EEG Processing Demo</h1>
            <p>Real-time brain signal acquisition and analysis</p>
            <div class="status">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Disconnected</span>
            </div>
        </div>

        <div class="controls">
            <button id="connectBtn">Connect Muse Headset</button>
            <button id="startBtn" disabled>Start Recording</button>
            <button id="stopBtn" disabled>Stop Recording</button>
            <button id="simulateBtn">Simulate EEG Data</button>
            <button id="clearBtn">Clear Data</button>
        </div>

        <div class="grid">
            <div class="panel">
                <h3>ðŸ“Š Real-time EEG Signal</h3>
                <canvas id="eegCanvas"></canvas>
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-label">Sample Rate</div>
                        <div class="metric-value" id="sampleRate">256 Hz</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Signal Quality</div>
                        <div class="metric-value" id="signalQuality">Good</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>ðŸŒŠ Frequency Spectrum</h3>
                <canvas id="spectrumCanvas"></canvas>
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-label">Alpha (8-12 Hz)</div>
                        <div class="metric-value" id="alphaPower">0.0</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Beta (13-30 Hz)</div>
                        <div class="metric-value" id="betaPower">0.0</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Theta (4-7 Hz)</div>
                        <div class="metric-value" id="thetaPower">0.0</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Attention Index</div>
                        <div class="metric-value" id="attentionIndex">0.0</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h3>ðŸ“‹ Event Log</h3>
            <div class="log" id="eventLog"></div>
        </div>

        <div class="code-section">
            <h4>ðŸ”§ Signal Processing Pipeline</h4>
            <pre><code><span class="comment">// Real-time EEG processing implementation</span>
<span class="highlight">class</span> <span class="string">EEGProcessor</span> {
    <span class="highlight">constructor</span>(<span class="string">sampleRate</span> = <span class="number">256</span>) {
        <span class="highlight">this</span>.<span class="string">sampleRate</span> = sampleRate;
        <span class="highlight">this</span>.<span class="string">buffer</span> = [];
        <span class="highlight">this</span>.<span class="string">windowSize</span> = <span class="number">512</span>; <span class="comment">// 2 seconds at 256 Hz</span>
        <span class="highlight">this</span>.<span class="string">filters</span> = <span class="highlight">this</span>.<span class="string">initializeFilters</span>();
    }

    <span class="highlight">processNewSample</span>(sample) {
        <span class="comment">// Add to circular buffer</span>
        <span class="highlight">this</span>.<span class="string">buffer</span>.<span class="string">push</span>(sample);
        <span class="highlight">if</span> (<span class="highlight">this</span>.<span class="string">buffer</span>.<span class="string">length</span> > <span class="highlight">this</span>.<span class="string">windowSize</span>) {
            <span class="highlight">this</span>.<span class="string">buffer</span>.<span class="string">shift</span>();
        }

        <span class="comment">// Apply real-time filtering</span>
        <span class="highlight">const</span> filtered = <span class="highlight">this</span>.<span class="string">applyBandpassFilter</span>(sample, <span class="number">1</span>, <span class="number">50</span>);
        
        <span class="comment">// Update spectral analysis every 100ms</span>
        <span class="highlight">if</span> (<span class="highlight">this</span>.<span class="string">buffer</span>.<span class="string">length</span> === <span class="highlight">this</span>.<span class="string">windowSize</span>) {
            <span class="highlight">const</span> spectrum = <span class="highlight">this</span>.<span class="string">computeFFT</span>(<span class="highlight">this</span>.<span class="string">buffer</span>);
            <span class="highlight">this</span>.<span class="string">updateFrequencyBands</span>(spectrum);
        }
    }

    <span class="highlight">computeFFT</span>(data) {
        <span class="comment">// Fast Fourier Transform implementation</span>
        <span class="comment">// Returns frequency domain representation</span>
        <span class="highlight">return</span> <span class="string">fft</span>(data);
    }
}</code></pre>
        </div>

        <div class="code-section">
            <h4>ðŸŽ¯ Frequency Band Analysis</h4>
            <pre><code><span class="comment">// Extract power in specific frequency bands</span>
<span class="highlight">function</span> <span class="string">extractBandPower</span>(spectrum, minFreq, maxFreq, sampleRate) {
    <span class="highlight">const</span> freqResolution = sampleRate / spectrum.<span class="string">length</span>;
    <span class="highlight">const</span> startBin = <span class="string">Math</span>.<span class="string">floor</span>(minFreq / freqResolution);
    <span class="highlight">const</span> endBin = <span class="string">Math</span>.<span class="string">ceil</span>(maxFreq / freqResolution);
    
    <span class="highlight">let</span> power = <span class="number">0</span>;
    <span class="highlight">for</span> (<span class="highlight">let</span> i = startBin; i <= endBin; i++) {
        power += spectrum[i] * spectrum[i]; <span class="comment">// Power = |X[k]|Â²</span>
    }
    
    <span class="highlight">return</span> <span class="string">Math</span>.<span class="string">sqrt</span>(power / (endBin - startBin + <span class="number">1</span>));
}

<span class="comment">// Calculate attention index (beta/theta ratio)</span>
<span class="highlight">function</span> <span class="string">calculateAttentionIndex</span>(betaPower, thetaPower) {
    <span class="highlight">return</span> thetaPower > <span class="number">0</span> ? (betaPower / thetaPower).<span class="string">toFixed</span>(<span class="number">2</span>) : <span class="number">0</span>;
}</code></pre>
        </div>
    </div>

    <script>
        // EEG Demo Implementation
        class EEGDemo {
            constructor() {
                this.isConnected = false;
                this.isRecording = false;
                this.sampleRate = 256;
                this.buffer = [];
                this.windowSize = 512;
                this.simulationInterval = null;
                this.processingInterval = null;
                
                this.initializeElements();
                this.initializeCanvases();
                this.setupEventListeners();
                this.log('EEG Demo initialized');
            }

            initializeElements() {
                this.elements = {
                    connectBtn: document.getElementById('connectBtn'),
                    startBtn: document.getElementById('startBtn'),
                    stopBtn: document.getElementById('stopBtn'),
                    simulateBtn: document.getElementById('simulateBtn'),
                    clearBtn: document.getElementById('clearBtn'),
                    statusIndicator: document.getElementById('statusIndicator'),
                    statusText: document.getElementById('statusText'),
                    eventLog: document.getElementById('eventLog'),
                    alphaPower: document.getElementById('alphaPower'),
                    betaPower: document.getElementById('betaPower'),
                    thetaPower: document.getElementById('thetaPower'),
                    attentionIndex: document.getElementById('attentionIndex')
                };
            }

            initializeCanvases() {
                this.eegCanvas = document.getElementById('eegCanvas');
                this.spectrumCanvas = document.getElementById('spectrumCanvas');
                this.eegCtx = this.eegCanvas.getContext('2d');
                this.spectrumCtx = this.spectrumCanvas.getContext('2d');
                
                // Set canvas dimensions
                this.resizeCanvases();
                window.addEventListener('resize', () => this.resizeCanvases());
            }

            resizeCanvases() {
                const rect = this.eegCanvas.getBoundingClientRect();
                this.eegCanvas.width = rect.width;
                this.eegCanvas.height = rect.height;
                this.spectrumCanvas.width = rect.width;
                this.spectrumCanvas.height = rect.height;
            }

            setupEventListeners() {
                this.elements.connectBtn.addEventListener('click', () => this.connectMuse());
                this.elements.startBtn.addEventListener('click', () => this.startRecording());
                this.elements.stopBtn.addEventListener('click', () => this.stopRecording());
                this.elements.simulateBtn.addEventListener('click', () => this.toggleSimulation());
                this.elements.clearBtn.addEventListener('click', () => this.clearData());
            }

            async connectMuse() {
                try {
                    this.log('Attempting to connect to Muse headset...');
                    
                    // Check if Web Bluetooth is available
                    if (!navigator.bluetooth) {
                        throw new Error('Web Bluetooth not supported');
                    }

                    // Request Bluetooth device
                    const device = await navigator.bluetooth.requestDevice({
                        filters: [{ namePrefix: 'Muse' }],
                        optionalServices: ['0000fe8d-0000-1000-8000-00805f9b34fb']
                    });

                    this.log(`Connecting to ${device.name}...`);
                    const server = await device.gatt.connect();
                    
                    this.setConnected(true);
                    this.log('Successfully connected to Muse headset!');
                    
                } catch (error) {
                    this.log(`Connection failed: ${error.message}`);
                    this.log('Tip: Make sure your Muse is in pairing mode and nearby');
                }
            }

            setConnected(connected) {
                this.isConnected = connected;
                this.elements.statusIndicator.classList.toggle('connected', connected);
                this.elements.statusText.textContent = connected ? 'Connected' : 'Disconnected';
                this.elements.startBtn.disabled = !connected;
                this.elements.connectBtn.textContent = connected ? 'Disconnect' : 'Connect Muse Headset';
            }

            startRecording() {
                this.isRecording = true;
                this.elements.startBtn.disabled = true;
                this.elements.stopBtn.disabled = false;
                this.log('Started EEG recording');
                this.startProcessingLoop();
            }

            stopRecording() {
                this.isRecording = false;
                this.elements.startBtn.disabled = false;
                this.elements.stopBtn.disabled = true;
                this.log('Stopped EEG recording');
                // Only stop processing if simulation is not running
                if (!this.simulationInterval && this.processingInterval) {
                    clearInterval(this.processingInterval);
                    this.processingInterval = null;
                }
            }

            startProcessingLoop() {
                if (!this.processingInterval) {
                    this.processingInterval = setInterval(() => this.processData(), 1000 / 60); // 60 FPS
                }
            }

            toggleSimulation() {
                if (this.simulationInterval) {
                    clearInterval(this.simulationInterval);
                    this.simulationInterval = null;
                    this.elements.simulateBtn.textContent = 'Simulate EEG Data';
                    this.log('Stopped EEG simulation');
                } else {
                    this.startSimulation();
                    this.elements.simulateBtn.textContent = 'Stop Simulation';
                    this.log('Started EEG simulation');
                }
            }

            startSimulation() {
                this.simulationInterval = setInterval(() => {
                    // Generate realistic EEG-like signal
                    const t = Date.now() / 1000;
                    const alpha = Math.sin(2 * Math.PI * 10 * t) * 20; // 10 Hz alpha
                    const beta = Math.sin(2 * Math.PI * 20 * t) * 10; // 20 Hz beta
                    const noise = (Math.random() - 0.5) * 30;
                    const sample = alpha + beta + noise;
                    
                    this.addSample(sample);
                }, 1000 / this.sampleRate);
                // Ensure rendering runs even without recording
                this.startProcessingLoop();
            }

            addSample(sample) {
                this.buffer.push(sample);
                if (this.buffer.length > this.windowSize * 2) {
                    this.buffer.shift();
                }
            }

            processData() {
                if (this.buffer.length < this.windowSize) return;

                // Get latest window
                const window = this.buffer.slice(-this.windowSize);
                
                // Compute FFT (simplified)
                const spectrum = this.computeSpectrum(window);
                
                // Extract frequency bands
                const alphaPower = this.extractBandPower(spectrum, 8, 12);
                const betaPower = this.extractBandPower(spectrum, 13, 30);
                const thetaPower = this.extractBandPower(spectrum, 4, 7);
                
                // Update displays
                this.updateMetrics(alphaPower, betaPower, thetaPower);
                this.drawEEGSignal(window);
                this.drawSpectrum(spectrum);
            }

            computeSpectrum(data) {
                // Simplified FFT - in real implementation use proper FFT library
                const spectrum = [];
                const N = data.length;
                
                for (let k = 0; k < N / 2; k++) {
                    let real = 0, imag = 0;
                    for (let n = 0; n < N; n++) {
                        const angle = -2 * Math.PI * k * n / N;
                        real += data[n] * Math.cos(angle);
                        imag += data[n] * Math.sin(angle);
                    }
                    spectrum[k] = Math.sqrt(real * real + imag * imag);
                }
                
                return spectrum;
            }

            extractBandPower(spectrum, minFreq, maxFreq) {
                const freqResolution = this.sampleRate / (spectrum.length * 2);
                const startBin = Math.floor(minFreq / freqResolution);
                const endBin = Math.ceil(maxFreq / freqResolution);
                
                let power = 0;
                for (let i = startBin; i <= endBin && i < spectrum.length; i++) {
                    power += spectrum[i] * spectrum[i];
                }
                
                return Math.sqrt(power / (endBin - startBin + 1));
            }

            updateMetrics(alpha, beta, theta) {
                this.elements.alphaPower.textContent = alpha.toFixed(1);
                this.elements.betaPower.textContent = beta.toFixed(1);
                this.elements.thetaPower.textContent = theta.toFixed(1);
                
                const attentionIndex = theta > 0 ? (beta / theta).toFixed(2) : '0.00';
                this.elements.attentionIndex.textContent = attentionIndex;
            }

            drawEEGSignal(data) {
                const ctx = this.eegCtx;
                const width = this.eegCanvas.width;
                const height = this.eegCanvas.height;
                
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, width, height);
                
                ctx.strokeStyle = '#00ff88';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                const stepX = width / data.length;
                const centerY = height / 2;
                const scaleY = height / 200; // Scale factor for visualization
                
                for (let i = 0; i < data.length; i++) {
                    const x = i * stepX;
                    const y = centerY - data[i] * scaleY;
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.stroke();
                
                // Draw center line
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(0, centerY);
                ctx.lineTo(width, centerY);
                ctx.stroke();
            }

            drawSpectrum(spectrum) {
                const ctx = this.spectrumCtx;
                const width = this.spectrumCanvas.width;
                const height = this.spectrumCanvas.height;
                
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, width, height);
                
                const maxFreq = this.sampleRate / 2;
                const freqStep = maxFreq / spectrum.length;
                const barWidth = width / spectrum.length;
                
                // Find max for scaling
                const maxPower = Math.max(...spectrum);
                
                for (let i = 0; i < spectrum.length && i * freqStep <= 50; i++) {
                    const freq = i * freqStep;
                    const power = spectrum[i];
                    const barHeight = (power / maxPower) * height * 0.8;
                    
                    // Color based on frequency band
                    let color = '#666';
                    if (freq >= 4 && freq <= 7) color = '#ff6b9d'; // Theta
                    else if (freq >= 8 && freq <= 12) color = '#00ff88'; // Alpha
                    else if (freq >= 13 && freq <= 30) color = '#ffd700'; // Beta
                    
                    ctx.fillStyle = color;
                    ctx.fillRect(i * barWidth, height - barHeight, barWidth - 1, barHeight);
                }
                
                // Draw frequency labels
                ctx.fillStyle = '#aaa';
                ctx.font = '10px monospace';
                ctx.fillText('0 Hz', 5, height - 5);
                ctx.fillText('25 Hz', width - 30, height - 5);
                ctx.fillText('50 Hz', width - 30, 15);
            }

            clearData() {
                this.buffer = [];
                this.log('Cleared all data');
                
                // Clear canvases
                this.eegCtx.fillStyle = '#000';
                this.eegCtx.fillRect(0, 0, this.eegCanvas.width, this.eegCanvas.height);
                this.spectrumCtx.fillStyle = '#000';
                this.spectrumCtx.fillRect(0, 0, this.spectrumCanvas.width, this.spectrumCanvas.height);
                
                // Reset metrics
                this.updateMetrics(0, 0, 0);
            }

            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${message}`;
                
                const logDiv = document.createElement('div');
                logDiv.textContent = logEntry;
                this.elements.eventLog.appendChild(logDiv);
                
                // Keep only last 50 entries
                while (this.elements.eventLog.children.length > 50) {
                    this.elements.eventLog.removeChild(this.elements.eventLog.firstChild);
                }
                
                // Scroll to bottom
                this.elements.eventLog.scrollTop = this.elements.eventLog.scrollHeight;
            }
        }

        // Initialize the demo when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.eegDemo = new EEGDemo();
        });
    </script>
</body>
</html>
